<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>trimeshloader: Tutorial 3: Flexible Low Level Loading</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">trimeshloader
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">Flexible ANSI C trimeshloader 3DS/OBJ</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Tutorial 3: Flexible Low Level Loading </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial shows how to use the low level loading functions and how to fill custom data structures. Nearly all ODE and application code is stripped. Only some lines are left for orientation.</p>
<h2>Custom data structure</h2>
<p>Ode Trimesh creators need simple (only points, floats or doubles) vertices and indices (int). The high level structure <a class="el" href="structtlTrimesh.html" title="Structure describing an Trimesh (index triangle list) containing objects, vertices (point...">tlTrimesh</a> provides complex vertices (point + uv map + normal) and unsigned short indices instead, which would be a waste of memory. We'd also need to copy the data again.</p>
<div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>CollisionTrimesh</div><div class="line">{</div><div class="line">    <span class="keywordtype">float</span> *vertex_buffer;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> vertex_count;</div><div class="line"></div><div class="line">    <span class="keywordtype">int</span> *face_buffer;</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> face_count;</div><div class="line">} CollisionTrimesh;</div></div><!-- fragment --><h2>Parsing and flexible data access</h2>
<p>The file is parsed the same way it was done in <a class="el" href="md_tutorials_tutorial2.html">Tutorial 2: Low Level Loading</a>, except that we now only load 3DS files, for readability. It is the same scheme:</p>
<ul>
<li>open the file</li>
<li>create a parser state</li>
<li>pass chunks to the parser</li>
<li>access data via low level access functions <a class="el" href="group__low__level__3ds__api.html#gae7fa7699ab3c289586f2846e69fcb01d">tl3dsGetVertex</a> / <a class="el" href="group__low__level__3ds__api.html#gad3fa2c287521bba595b8f7800f9ae365">tl3dsGetFace</a></li>
<li>destroy state and close file</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="tl3ds_8h.html">tl3ds.h</a>&quot;</span></div><div class="line"></div><div class="line">CollisionTrimesh *loadCollisionTrimesh( <span class="keyword">const</span> <span class="keywordtype">char</span> *filename )</div><div class="line">{</div><div class="line">    FILE *f = 0;</div><div class="line">    CollisionMesh *mesh = 0;</div><div class="line"></div><div class="line">    mesh = malloc( <span class="keyword">sizeof</span>(CollisionMesh)  );</div><div class="line"></div><div class="line">    f = fopen( filename, <span class="stringliteral">&quot;r&quot;</span> );</div><div class="line">    <span class="keywordflow">if</span>( f )</div><div class="line">    {</div><div class="line">        <span class="keywordtype">char</span> buffer[1024];</div><div class="line">        <a class="code" href="group__low__level__3ds__api.html#gaae26f087430a798f857c8791c0928ed7">tl3dsState</a> *state = 0;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> size = 0;</div><div class="line">        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0;</div><div class="line"></div><div class="line">        state = <a class="code" href="group__low__level__3ds__api.html#gad9041d7b29b9b585eb10b988443a1484">tl3dsCreateState</a>();</div><div class="line"></div><div class="line">        <span class="keywordflow">while</span>( !feof( f ) )</div><div class="line">        {</div><div class="line">            size = (<span class="keywordtype">unsigned</span> int) fread( buffer, 1, <span class="keyword">sizeof</span>(buffer), f );</div><div class="line">            <a class="code" href="group__low__level__3ds__api.html#gadfdaab3504c2f3e8f6b175ceb4478826">tl3dsParse</a>( state, buffer, size, size &lt; <span class="keyword">sizeof</span>(buffer) ? 1 : 0 );</div><div class="line">        }</div><div class="line"></div><div class="line">        mesh-&gt;vertex_count = <a class="code" href="group__low__level__3ds__api.html#ga6befde874e8d483ac08ff904f5a2182d">tl3dsVertexCount</a>( state );</div><div class="line">        mesh-&gt;vertex_buffer = malloc( <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>) * 3 * mesh-&gt;vertex_count );</div><div class="line">        <span class="keywordflow">for</span>( i = 0; i &lt; mesh-&gt;vertex_count; i++ )</div><div class="line">            <a class="code" href="group__low__level__3ds__api.html#gae7fa7699ab3c289586f2846e69fcb01d">tl3dsGetVertex</a>( state, i, &amp;mesh-&gt;vertex_buffer[3*i], &amp;mesh-&gt;vertex_buffer[3*i+1], &amp;mesh-&gt;vertex_buffer[3*i+2], 0, 0, 0, 0, 0 );</div><div class="line"></div><div class="line">        mesh-&gt;face_count = <a class="code" href="group__low__level__3ds__api.html#ga3c2296dbf41fac93fd5c820a57ffc21c">tl3dsFaceCount</a>( state );</div><div class="line">        mesh-&gt;face_buffer = malloc( <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>) * 3 * mesh-&gt;face_count );</div><div class="line">        <span class="keywordflow">for</span>( i = 0; i &lt; mesh-&gt;face_count; i++ )</div><div class="line">        {</div><div class="line">            <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> a = 0, b = 0, c = 0;</div><div class="line">            <a class="code" href="group__low__level__3ds__api.html#gad3fa2c287521bba595b8f7800f9ae365">tl3dsGetFace</a>( state, i, &amp;a, &amp;b, &amp;c );</div><div class="line"></div><div class="line">            <span class="comment">/* convert from unsigned to signed */</span></div><div class="line">            mesh-&gt;index_buffer[3*i] = a;</div><div class="line">            mesh-&gt;index_buffer[3*i+1] = b;</div><div class="line">            mesh-&gt;index_buffer[3*i+2] = c;</div><div class="line">        }</div><div class="line"></div><div class="line">        <a class="code" href="group__low__level__3ds__api.html#ga75de85923289c025c1b555ffe0ace461">tl3dsDestroyState</a>( state );</div><div class="line"></div><div class="line">        fclose( f );</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> mesh;</div><div class="line">}</div></div><!-- fragment --><p>Quicklink: <a class="el" href="md_tutorials_tutorial1.html">Tutorial 1: High Level Loading</a></p>
<p>Quicklink: <a class="el" href="md_tutorials_tutorial2.html">Tutorial 2: Low Level Loading</a></p>
<h2>Building the Trimesh Collision Shape</h2>
<p>This is for convinience only. Look at ODE documentation!</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;ode.h&quot;</span></div><div class="line"></div><div class="line"><span class="keywordtype">void</span> createCollisionShape( dSpace space,  dBody body, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename, dReal density )</div><div class="line">{</div><div class="line">    CollisionTrimesh *trimesh = loadCollisionTrimesh( <span class="stringliteral">&quot;test.3ds&quot;</span> )</div><div class="line">    dTriMeshDataID tridata = dGeomTriMeshDataCreate();</div><div class="line">    dGeomTriMeshDataBuildSingle (</div><div class="line">            tridata,</div><div class="line">            trimesh-&gt;vertex_buffer,</div><div class="line">            3 * sizeof ( <span class="keywordtype">float</span> ),</div><div class="line">            trimesh-&gt;vertex_count,</div><div class="line">            trimesh-&gt;face_buffer,</div><div class="line">            trimesh-&gt;face_count * 3,</div><div class="line">            3 * sizeof ( <span class="keywordtype">int</span> ) );</div><div class="line"></div><div class="line">    dGeomID mesh = dCreateTriMesh ( space, tridata, 0, 0, 0 );</div><div class="line">    dGeomSetBody ( mesh, body );</div><div class="line"></div><div class="line">    dMass mass;</div><div class="line">    dMassSetTrimesh ( &amp;mass, density, mesh );</div><div class="line">    dBodySetMass ( body, &amp;mass );</div><div class="line">} </div></div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
